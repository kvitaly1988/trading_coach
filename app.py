import os
from datetime import datetime

import pandas as pd
import plotly.graph_objs as go
import streamlit as st
import yfinance as yf
from streamlit_autorefresh import st_autorefresh


# ---------- –ù–ê–°–¢–†–û–ô–ö–ò ----------

USERS_FILE = "users.csv"
TRADES_FILE = "trades.csv"
PROGRESS_FILE = "theory_progress.csv"
START_BALANCE = 100_000

# 5 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
TICKERS = {
    "AAPL": "Apple",
    "MSFT": "Microsoft",
    "TSLA": "Tesla",
    "BTC-USD": "Bitcoin",
    "ETH-USD": "Ethereum",
}


# ---------- –¢–ï–û–†–ï–¢–ò–ß–ï–°–ö–ò–ï –ì–õ–ê–í–´ (–£–ß–ï–ë–ù–ò–ö) ----------

CHAPTERS = [
    {
        "id": "ch1",
        "title": "–ì–ª–∞–≤–∞ 1. –î–µ–Ω—å–≥–∏, —Ü–µ–ª–∏ –∏ –∏–Ω—Ñ–ª—è—Ü–∏—è",
        "text": """
–í —ç—Ç–æ–π –≥–ª–∞–≤–µ –º—ã —Ä–∞–∑–±–∏—Ä–∞–µ–º—Å—è, **–∑–∞—á–µ–º –≤–æ–æ–±—â–µ –Ω—É–∂–Ω—ã –¥–µ–Ω—å–≥–∏** –∏ –ø–æ—á–µ–º—É –ø—Ä–æ—Å—Ç–æ ¬´–∫–æ–ø–∏—Ç—å –ø–æ–¥ –ø–æ–¥—É—à–∫–æ–π¬ª ‚Äî –Ω–µ –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç.

### 1.1. –ó–∞—á–µ–º –ª—é–¥—è–º –¥–µ–Ω—å–≥–∏

–î–µ–Ω—å–≥–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç —Ç—Ä–∏ –≥–ª–∞–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- **–°—Ä–µ–¥—Å—Ç–≤–æ –æ–±–º–µ–Ω–∞** ‚Äî –∑–∞ –¥–µ–Ω—å–≥–∏ –º—ã –ø–æ–∫—É–ø–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∏ —É—Å–ª—É–≥–∏.
- **–ú–µ—Ä–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏** ‚Äî —Å –ø–æ–º–æ—â—å—é –¥–µ–Ω–µ–≥ –º–æ–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Ü–µ–Ω—É —Ä–∞–∑–Ω—ã—Ö –≤–µ—â–µ–π.
- **–°—Ä–µ–¥—Å—Ç–≤–æ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è** ‚Äî –¥–µ–Ω—å–≥–∏ –º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ.

–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å: –¥–µ–Ω—å–≥–∏ ‚Äî —ç—Ç–æ –Ω–µ —Ü–µ–ª—å —Å–∞–º–∞ –ø–æ —Å–µ–±–µ, –∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–π.

### 1.2. –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ü–µ–ª–∏

–£ –∫–∞–∂–¥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –µ—Å—Ç—å —Å–≤–æ–∏ —Ü–µ–ª–∏:
- –∫—É–ø–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –Ω–æ—É—Ç–±—É–∫;
- –æ–ø–ª–∞—Ç–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ;
- –Ω–∞–∫–æ–ø–∏—Ç—å –Ω–∞ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ;
- —Å–æ–∑–¥–∞—Ç—å ¬´–ø–æ–¥—É—à–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏¬ª –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º.

–•–æ—Ä–æ—à–∞—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Ü–µ–ª—å:
- **–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è** (—Å–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥),
- **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏** (–¥–æ –∫–∞–∫–æ–π –¥–∞—Ç—ã),
- **—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è**.

–ü—Ä–∏–º–µ—Ä:
- –ü–ª–æ—Ö–æ: ¬´–•–æ—á—É –º–Ω–æ–≥–æ –¥–µ–Ω–µ–≥¬ª.
- –•–æ—Ä–æ—à–æ: ¬´–•–æ—á—É –Ω–∞–∫–æ–ø–∏—Ç—å 60 000 ‚ÇΩ –∑–∞ 12 –º–µ—Å—è—Ü–µ–≤ –Ω–∞ –Ω–æ—É—Ç–±—É–∫¬ª.

### 1.3. –ò–Ω—Ñ–ª—è—Ü–∏—è ‚Äî —Ç–∏—Ö–∏–π –≤–æ—Ä

**–ò–Ω—Ñ–ª—è—Ü–∏—è** ‚Äî —ç—Ç–æ —Ä–æ—Å—Ç –æ–±—â–µ–≥–æ —É—Ä–æ–≤–Ω—è —Ü–µ–Ω –≤ —ç–∫–æ–Ω–æ–º–∏–∫–µ.

–ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –Ω–∞ 1 000 ‚ÇΩ –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å –æ–¥–Ω—É –∫–æ—Ä–∑–∏–Ω—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤,
–∞ —á–µ—Ä–µ–∑ –≥–æ–¥ –Ω–∞ —ç—Ç–∏ –∂–µ 1 000 ‚ÇΩ ‚Äî —É–∂–µ –º–µ–Ω—å—à–µ,
–∑–Ω–∞—á–∏—Ç, –¥–µ–Ω—å–≥–∏ **–æ–±–µ—Å—Ü–µ–Ω–∏–ª–∏—Å—å**.

–í—ã–≤–æ–¥:
- –µ—Å–ª–∏ –¥–µ–Ω—å–≥–∏ –ø—Ä–æ—Å—Ç–æ –ª–µ–∂–∞—Ç –¥–æ–º–∞ –∏–ª–∏ –Ω–∞ —Å—á—ë—Ç–µ –±–µ–∑ –ø—Ä–æ—Ü–µ–Ω—Ç–∞,
  –∏—Ö –ø–æ–∫—É–ø–∞—Ç–µ–ª—å–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º –ø–∞–¥–∞–µ—Ç.

### 1.4. –°–±–µ—Ä–µ–∂–µ–Ω–∏—è –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏

**–°–±–µ—Ä–µ–∂–µ–Ω–∏—è** ‚Äî —ç—Ç–æ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –¥–µ–Ω—å–≥–∏ —Å —Ü–µ–ª—å—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- –ø–æ–¥—É—à–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–∑–∞–ø–∞—Å –Ω–∞ 3‚Äì6 –º–µ—Å—è—Ü–µ–≤ –∂–∏–∑–Ω–∏),
- –¥–µ–Ω—å–≥–∏ –Ω–∞ –±–ª–∏–∂–∞–π—à—É—é –≤–∞–∂–Ω—É—é —Ü–µ–ª—å.

**–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏** ‚Äî —ç—Ç–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –¥–µ–Ω–µ–≥ –≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ:
- –º–æ–≥—É—Ç –ø—Ä–∏–Ω–æ—Å–∏—Ç—å –¥–æ—Ö–æ–¥,
- –Ω–æ –≤—Å–µ–≥–¥–∞ –Ω–µ—Å—É—Ç **—Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä—å**.

–õ–æ–≥–∏–∫–∞ —Ç–∞–∫–∞—è:
1. –°–Ω–∞—á–∞–ª–∞ ‚Äî –±–∞–∑–æ–≤—ã–µ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è –∏ –ø–æ–¥—É—à–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
2. –ü–æ—Ç–æ–º ‚Äî –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏ –±–æ–ª–µ–µ —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (–∞–∫—Ü–∏–∏, —Ç—Ä–µ–π–¥–∏–Ω–≥ –∏ —Ç. –¥.).
        """,
        "questions": [
            {
                "q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –∏–Ω—Ñ–ª—è—Ü–∏—è?",
                "options": [
                    "–†–æ—Å—Ç –∑–∞—Ä–ø–ª–∞—Ç —É –Ω–∞—Å–µ–ª–µ–Ω–∏—è",
                    "–†–æ—Å—Ç –æ–±—â–µ–≥–æ —É—Ä–æ–≤–Ω—è —Ü–µ–Ω –∏ —Å–Ω–∏–∂–µ–Ω–∏–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –¥–µ–Ω–µ–≥",
                    "–°–Ω–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω –≤ –º–∞–≥–∞–∑–∏–Ω–∞—Ö",
                    "–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫—É–ø—é—Ä –≤ –∫–æ—à–µ–ª—å–∫–µ",
                ],
                "correct": 1,
            },
            {
                "q": "–ß—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è –æ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π?",
                "options": [
                    "–°–±–µ—Ä–µ–∂–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ —Å–≤—è–∑–∞–Ω—ã —Å –±–æ–ª—å—à–∏–º —Ä–∏—Å–∫–æ–º",
                    "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –¥–µ–ª–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞–ª–∏—á–Ω—ã–º–∏",
                    "–°–±–µ—Ä–µ–∂–µ–Ω–∏—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ ‚Äî –Ω–∞ –¥–æ—Ö–æ–¥ —Å —Ä–∏—Å–∫–æ–º",
                    "–†–∞–∑–Ω–∏—Ü—ã –Ω–µ—Ç, —ç—Ç–æ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ",
                ],
                "correct": 2,
            },
            {
                "q": "–ö–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –ø—Ä–∏–º–µ—Ä —Ö–æ—Ä–æ—à–µ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Ü–µ–ª–∏?",
                "options": [
                    "–°—Ç–∞—Ç—å –±–æ–≥–∞—Ç—ã–º",
                    "–•–æ—á—É –º–Ω–æ–≥–æ –¥–µ–Ω–µ–≥ –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å",
                    "–ù–∞–∫–æ–ø–∏—Ç—å 30 000 ‚ÇΩ –∑–∞ 6 –º–µ—Å—è—Ü–µ–≤ –Ω–∞ –Ω–æ–≤—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω",
                    "–ü—Ä–æ—Å—Ç–æ –∫–æ–ø–∏—Ç—å ¬´–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π¬ª –±–µ–∑ —Å—É–º–º—ã –∏ —Å—Ä–æ–∫–∞",
                ],
                "correct": 2,
            },
        ],
    },
    {
        "id": "ch2",
        "title": "–ì–ª–∞–≤–∞ 2. –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: –∞–∫—Ü–∏–∏, –æ–±–ª–∏–≥–∞—Ü–∏–∏, ETF",
        "text": """
–¢–µ–ø–µ—Ä—å —Ä–∞–∑–±–µ—Ä—ë–º—Å—è, **–≤–æ —á—Ç–æ –≤–æ–æ–±—â–µ –º–æ–∂–Ω–æ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å**.

### 2.1. –ê–∫—Ü–∏–∏

**–ê–∫—Ü–∏—è** ‚Äî —ç—Ç–æ –º–∞–ª–µ–Ω—å–∫–∞—è –¥–æ–ª—è –∫–æ–º–ø–∞–Ω–∏–∏.

–ü–æ–∫—É–ø–∞—è –∞–∫—Ü–∏—é, –≤—ã —Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å **—Å–æ–≤–ª–∞–¥–µ–ª—å—Ü–µ–º –±–∏–∑–Ω–µ—Å–∞**.

–î–æ—Ö–æ–¥ –æ—Ç –∞–∫—Ü–∏–π –º–æ–∂–µ—Ç –±—ã—Ç—å:
- –æ—Ç **—Ä–æ—Å—Ç–∞ —Ü–µ–Ω—ã** (–∫—É–ø–∏–ª –¥–µ—à–µ–≤–ª–µ, –ø—Ä–æ–¥–∞–ª –¥–æ—Ä–æ–∂–µ),
- –æ—Ç **–¥–∏–≤–∏–¥–µ–Ω–¥–æ–≤** (—á–∞—Å—Ç—å –ø—Ä–∏–±—ã–ª–∏, –∫–æ—Ç–æ—Ä—É—é –∫–æ–º–ø–∞–Ω–∏—è –¥–µ–ª–∏—Ç —Å –∞–∫—Ü–∏–æ–Ω–µ—Ä–∞–º–∏).

–ù–æ —Ü–µ–Ω–∞ –∞–∫—Ü–∏–π –º–æ–∂–µ—Ç –∏ –ø–∞–¥–∞—Ç—å ‚Äî —ç—Ç–æ —Ä–∏—Å–∫.  
–ù–∏–∫–∞–∫–∏—Ö –≥–∞—Ä–∞–Ω—Ç–∏–π –ø—Ä–∏–±—ã–ª–∏ –Ω–µ—Ç.

### 2.2. –û–±–ª–∏–≥–∞—Ü–∏–∏

**–û–±–ª–∏–≥–∞—Ü–∏—è** ‚Äî —ç—Ç–æ –ø–æ —Å—É—Ç–∏ **–¥–æ–ª–≥–æ–≤–∞—è —Ä–∞—Å–ø–∏—Å–∫–∞**:

- –≤—ã –¥–∞—ë—Ç–µ –¥–µ–Ω—å–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–ª–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤—É,
- –≤–∞–º –æ–±–µ—â–∞—é—Ç:
  - —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø–ª–∞—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç—ã (–∫—É–ø–æ–Ω),
  - –≤–µ—Ä–Ω—É—Ç—å –¥–æ–ª–≥ –≤ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π —Å—Ä–æ–∫.

–†–∏—Å–∫ –ø–æ –æ–±–ª–∏–≥–∞—Ü–∏—è–º –æ–±—ã—á–Ω–æ **–Ω–∏–∂–µ**, —á–µ–º –ø–æ –∞–∫—Ü–∏—è–º,
–Ω–æ –∏ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, –Ω–∏–∂–µ.

### 2.3. ETF ‚Äî –±–∏—Ä–∂–µ–≤—ã–µ —Ñ–æ–Ω–¥—ã

**ETF (Exchange Traded Fund)** ‚Äî –±–∏—Ä–∂–µ–≤–æ–π —Ñ–æ–Ω–¥.

–ü—Ä–µ–¥—Å—Ç–∞–≤—å ¬´–∫–æ—Ä–∑–∏–Ω—É¬ª, –≤–Ω—É—Ç—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π:
- –º–Ω–æ–≥–æ —Ä–∞–∑–Ω—ã—Ö –∞–∫—Ü–∏–π,
- –∏–ª–∏ –Ω–∞–±–æ—Ä –æ–±–ª–∏–≥–∞—Ü–∏–π,
- –∏–ª–∏ —Ü–µ–ª—ã–π —Ä—ã–Ω–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–Ω–¥–µ–∫—Å).

–ü–æ–∫—É–ø–∞—è –æ–¥–Ω—É –±—É–º–∞–≥—É ETF, –≤—ã **–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤–∫–ª–∞–¥—ã–≤–∞–µ—Ç–µ—Å—å –≤–æ –≤—Å–µ –∞–∫—Ç–∏–≤—ã –≤–Ω—É—Ç—Ä–∏**.

–ü–ª—é—Å—ã:
- –≥–æ—Ç–æ–≤–∞—è –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è,
- –ø—Ä–æ—â–µ, —á–µ–º —Å–∞–º–æ–º—É –≤—ã–±–∏—Ä–∞—Ç—å –¥–µ—Å—è—Ç–∫–∏ –±—É–º–∞–≥.

### 2.4. –î—Ä—É–≥–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (–≤ –æ–±—â–∏—Ö —á–µ—Ä—Ç–∞—Ö)

- **–í–∞–ª—é—Ç–∞** ‚Äî –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–∞–ª—é—Ç–∞–º–∏ (USD, EUR –∏ —Ç. –¥.).
- **–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã** ‚Äî –æ—á–µ–Ω—å –≤–æ–ª–∞—Ç–∏–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä–æ–≤—ã–µ –∞–∫—Ç–∏–≤—ã, ÿßŸÑÿ≥ÿπÿ± –∫–æ—Ç–æ—Ä—ã—Ö –º–æ–∂–µ—Ç —Å–∏–ª—å–Ω–æ –º–µ–Ω—è—Ç—å—Å—è.
- **–í–∫–ª–∞–¥—ã** ‚Äî –ø–æ—á—Ç–∏ –±–µ–∑ —Ä–∏—Å–∫–∞, –Ω–æ –∏ –¥–æ—Ö–æ–¥ –Ω–µ–±–æ–ª—å—à–æ–π.

–î–ª—è —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ —Ä–∞–∑—É–º–Ω–µ–µ —Å–Ω–∞—á–∞–ª–∞ –ø–æ–Ω—è—Ç—å **–∞–∫—Ü–∏–∏, –æ–±–ª–∏–≥–∞—Ü–∏–∏ –∏ ETF**, –∞ –Ω–µ –±—Ä–æ—Å–∞—Ç—å—Å—è –≤ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã –∏ —Å–ª–æ–∂–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.
        """,
        "questions": [
            {
                "q": "–ß—Ç–æ –ª—É—á—à–µ –≤—Å–µ–≥–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∞–∫—Ü–∏—é?",
                "options": [
                    "–î–æ–ª–≥–æ–≤–∞—è —Ä–∞—Å–ø–∏—Å–∫–∞ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞",
                    "–î–æ–ª—è –≤ –∫–æ–º–ø–∞–Ω–∏–∏, –¥–∞—é—â–∞—è –ø—Ä–∞–≤–æ –Ω–∞ —á–∞—Å—Ç—å –µ—ë –ø—Ä–∏–±—ã–ª–∏",
                    "–í–∏–¥ –≤–∞–ª—é—Ç—ã",
                    "–õ–æ—Ç–µ—Ä–µ–π–Ω—ã–π –±–∏–ª–µ—Ç",
                ],
                "correct": 1,
            },
            {
                "q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –æ–±–ª–∏–≥–∞—Ü–∏—è?",
                "options": [
                    "–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞",
                    "–§—å—é—á–µ—Ä—Å–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç",
                    "–î–æ–ª–≥–æ–≤–∞—è —Ä–∞—Å–ø–∏—Å–∫–∞: –≤—ã –∑–∞–Ω–∏–º–∞–µ—Ç–µ –¥–µ–Ω—å–≥–∏ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–ª–∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤—É",
                    "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –±–æ–Ω—É—Å –æ—Ç –±—Ä–æ–∫–µ—Ä–∞",
                ],
                "correct": 2,
            },
            {
                "q": "–ß–µ–º —É–¥–æ–±–µ–Ω ETF –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–µ–≥–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞?",
                "options": [
                    "–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä–∏–±—ã–ª—å –±–µ–∑ —Ä–∏—Å–∫–∞",
                    "–î–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∞–º",
                    "–ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–¥–Ω–æ–π –ø–æ–∫—É–ø–∫–æ–π –≤–ª–æ–∂–∏—Ç—å—Å—è —Å—Ä–∞–∑—É –≤ –Ω–∞–±–æ—Ä —Ä–∞–∑–Ω—ã—Ö –∞–∫—Ç–∏–≤–æ–≤",
                    "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–≥–æ —Ç—Ä–µ–π–¥–∏–Ω–≥–∞",
                ],
                "correct": 2,
            },
        ],
    },
    {
        "id": "ch3",
        "title": "–ì–ª–∞–≤–∞ 3. –ë–∏—Ä–∂–∞, –±—Ä–æ–∫–µ—Ä –∏ –º–µ—Ö–∞–Ω–∏–∑–º —Å–¥–µ–ª–æ–∫",
        "text": """
–í —ç—Ç–æ–π –≥–ª–∞–≤–µ —Ä–∞–∑–±–µ—Ä—ë–º, **–∫–∞–∫ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å–¥–µ–ª–∫–∞**.

### 3.1. –ë–∏—Ä–∂–∞

**–ë–∏—Ä–∂–∞** ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ä—ã–Ω–æ–∫, –≥–¥–µ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è:
- –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏ —Ü–µ–Ω–Ω—ã—Ö –±—É–º–∞–≥,
- –ø—Ä–æ–¥–∞–≤—Ü—ã.

–ë–∏—Ä–∂–∞:
- –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞—è–≤–∫–∏,
- —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Å–¥–µ–ª–∫–∏,
- —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –±–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Ç–æ—Ä–≥–æ–≤.

–ü—Ä–∏–º–µ—Ä—ã –º–∏—Ä–æ–≤—ã—Ö –±–∏—Ä–∂: NYSE, NASDAQ –∏ –¥—Ä.

### 3.2. –ë—Ä–æ–∫–µ—Ä

–ß–∞—Å—Ç–Ω—ã–π –∏–Ω–≤–µ—Å—Ç–æ—Ä –Ω–∞–ø—Ä—è–º—É—é –∫ –±–∏—Ä–∂–µ –æ–±—ã—á–Ω–æ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω.

**–ë—Ä–æ–∫–µ—Ä** ‚Äî –ø–æ—Å—Ä–µ–¥–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π:
- –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–∞–º —Å—á—ë—Ç,
- –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ—Ç –≤–∞—Å –ø—Ä–∏–∫–∞–∑—ã (–∑–∞—è–≤–∫–∏),
- –≤—ã–≤–æ–¥–∏—Ç –∏—Ö –Ω–∞ –±–∏—Ä–∂—É,
- —Å–ø–∏—Å—ã–≤–∞–µ—Ç –∏ –∑–∞—á–∏—Å–ª—è–µ—Ç –¥–µ–Ω—å–≥–∏ –∏ –±—É–º–∞–≥–∏,
- –≤–∑–∏–º–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏—é –∑–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏.

–í –Ω–∞—à–µ–º —Ç—Ä–µ–Ω–∞–∂—ë—Ä–µ —Ä–æ–ª—å –±—Ä–æ–∫–µ—Ä–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∞:
–≤—ã –Ω–∞–∂–∏–º–∞–µ—Ç–µ **BUY/SELL**, –∏ —Å–¥–µ–ª–∫–∞ —Å–æ–≤–µ—Ä—à–∞–µ—Ç—Å—è –ø–æ **—Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω–µ**.

### 3.3. –¢–∏–ø—ã –∑–∞—è–≤–æ–∫ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)

- **–†—ã–Ω–æ—á–Ω–∞—è –∑–∞—è–≤–∫–∞** ‚Äî –∫—É–ø–∏—Ç—å/–ø—Ä–æ–¥–∞—Ç—å –ø–æ —Ç–µ–∫—É—â–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π —Ü–µ–Ω–µ –Ω–∞ —Ä—ã–Ω–∫–µ.
- **–õ–∏–º–∏—Ç–Ω–∞—è –∑–∞—è–≤–∫–∞** ‚Äî –∫—É–ø–∏—Ç—å –Ω–µ –¥–æ—Ä–æ–∂–µ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ü–µ–Ω—ã –∏–ª–∏ –ø—Ä–æ–¥–∞—Ç—å –Ω–µ –¥–µ—à–µ–≤–ª–µ.

–í —Ç—Ä–µ–Ω–∞–∂—ë—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ä—ã–Ω–æ—á–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ** –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã.

### 3.4. –ö–æ–º–∏—Å—Å–∏–∏ –∏ –Ω–∞–ª–æ–≥–∏ (–≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏)

–í —Ä–µ–∞–ª—å–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–µ:
- –±—Ä–æ–∫–µ—Ä –∏ –±–∏—Ä–∂–∞ –±–µ—Ä—É—Ç **–∫–æ–º–∏—Å—Å–∏–∏** –∑–∞ —Å–¥–µ–ª–∫–∏;
- –ø—Ä–∏–±—ã–ª—å –ø–æ —Å—á—ë—Ç—É –æ–±–ª–∞–≥–∞–µ—Ç—Å—è **–Ω–∞–ª–æ–≥–æ–º**.

–í —Ç—Ä–µ–Ω–∞–∂—ë—Ä–µ –º—ã –∫–æ–º–∏—Å—Å–∏–∏ –∏ –Ω–∞–ª–æ–≥–∏ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ–º,
—á—Ç–æ–±—ã —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ –ª–æ–≥–∏–∫–µ —Ä–µ—à–µ–Ω–∏–π –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤.
        """,
        "questions": [
            {
                "q": "–ó–∞—á–µ–º –Ω—É–∂–µ–Ω –±—Ä–æ–∫–µ—Ä?",
                "options": [
                    "–ß—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–±—ã–ª—å",
                    "–ß—Ç–æ–±—ã –ø–æ–¥–∫–ª—é—á–∞—Ç—å —á–∞—Å—Ç–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ –∫ –±–∏—Ä–∂–µ –∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∏—Ö –∑–∞—è–≤–∫–∏",
                    "–ß—Ç–æ–±—ã —Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–ª–∏—á–Ω—ã–µ –¥–æ–º–∞",
                    "–ß—Ç–æ–±—ã –ø–µ—á–∞—Ç–∞—Ç—å –¥–µ–Ω—å–≥–∏",
                ],
                "correct": 1,
            },
            {
                "q": "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ä—ã–Ω–æ—á–Ω–∞—è –∑–∞—è–≤–∫–∞?",
                "options": [
                    "–ó–∞—è–≤–∫–∞, –∏—Å–ø–æ–ª–Ω—è–µ–º–∞—è –ø–æ —Ç–µ–∫—É—â–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π —Ü–µ–Ω–µ",
                    "–ó–∞—è–≤–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è",
                    "–ü–∏—Å—å–º–æ –≤ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É",
                    "–ö–æ–º–∞–Ω–¥–∞ –∑–∞–∫—Ä—ã—Ç—å —Å—á—ë—Ç",
                ],
                "correct": 0,
            },
            {
                "q": "–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –±–∏—Ä–∂–∞?",
                "options": [
                    "–í—ã–¥–∞—ë—Ç –∫—Ä–µ–¥–∏—Ç—ã –Ω–∞—Å–µ–ª–µ–Ω–∏—é",
                    "–û—Ä–≥–∞–Ω–∏–∑—É–µ—Ç —Ç–æ—Ä–≥–æ–≤–ª—é –∏ —Å–≤–æ–¥–∏—Ç –∑–∞—è–≤–∫–∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –∏ –ø—Ä–æ–¥–∞–≤—Ü–æ–≤",
                    "–•—Ä–∞–Ω–∏—Ç –Ω–∞–ª–∏—á–Ω—ã–µ –¥–µ–Ω—å–≥–∏ –≥—Ä–∞–∂–¥–∞–Ω",
                    "–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã –≤ –∫–æ–º–ø–∞–Ω–∏—è—Ö",
                ],
                "correct": 1,
            },
        ],
    },
    {
        "id": "ch4",
        "title": "–ì–ª–∞–≤–∞ 4. –†–∏—Å–∫, –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –∏ –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è",
        "text": """
–õ—é–±—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏ —Ç—Ä–µ–π–¥–∏–Ω–≥ —Å–≤—è–∑–∞–Ω—ã —Å **—Ä–∏—Å–∫–æ–º**. –ì–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–µ –∏–∑–±–µ–∂–∞—Ç—å —Ä–∏—Å–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é (—ç—Ç–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ), –∞ **—É–ø—Ä–∞–≤–ª—è—Ç—å –∏–º**.

### 4.1. –°–≤—è–∑–∫–∞ ¬´—Ä–∏—Å–∫ ‚Äî –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å¬ª

–û–±—â–µ–µ –ø—Ä–∞–≤–∏–ª–æ:
> –ß–µ–º –≤—ã—à–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å, —Ç–µ–º –≤—ã—à–µ —Ä–∏—Å–∫.

–ü—Ä–∏–º–µ—Ä—ã:
- –û–±–ª–∏–≥–∞—Ü–∏–∏ –Ω–∞–¥—ë–∂–Ω—ã—Ö —ç–º–∏—Ç–µ–Ω—Ç–æ–≤ ‚Üí –Ω–∏–∂–µ —Ä–∏—Å–∫, —É–º–µ—Ä–µ–Ω–Ω–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å.
- –ê–∫—Ü–∏–∏ –∫–æ–º–ø–∞–Ω–∏–π ‚Üí –≤—ã—à–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–æ—Ö–æ–¥–∞, –≤—ã—à–µ —Ä–∏—Å–∫.
- –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã ‚Üí –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å.

–ï—Å–ª–∏ –≤–∞–º –æ–±–µ—â–∞—é—Ç ¬´–æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π –¥–æ—Ö–æ–¥ –±–µ–∑ —Ä–∏—Å–∫–∞¬ª ‚Äî —ç—Ç–æ –ø–æ–≤–æ–¥ –Ω–∞—Å—Ç–æ—Ä–æ–∂–∏—Ç—å—Å—è.

### 4.2. –î–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è

**–î–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è** ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–ª–æ–∂–µ–Ω–∏–π –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –∞–∫—Ç–∏–≤–∞–º–∏:
- —Ä–∞–∑–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏,
- —Ä–∞–∑–Ω—ã–µ –æ—Ç—Ä–∞—Å–ª–∏,
- —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–∞–∫—Ü–∏–∏, –æ–±–ª–∏–≥–∞—Ü–∏–∏, ETF).

–°–º—ã—Å–ª:
- –µ—Å–ª–∏ –æ–¥–Ω–∞ –∫–æ–º–ø–∞–Ω–∏—è —Å–∏–ª—å–Ω–æ —É–ø–∞–ª–∞ –≤ —Ü–µ–Ω–µ,
  —ç—Ç–æ –Ω–µ —Ä–∞–∑—Ä—É—à–∏—Ç –≤–µ—Å—å –ø–æ—Ä—Ç—Ñ–µ–ª—å.

### 4.3. –ì–æ—Ä–∏–∑–æ–Ω—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–ì–æ—Ä–∏–∑–æ–Ω—Ç** ‚Äî —Å—Ä–æ–∫, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –≤–ª–æ–∂–µ–Ω–∏—è:
- –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π (–¥–Ω–∏, –Ω–µ–¥–µ–ª–∏),
- —Å—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–π (–º–µ—Å—è—Ü—ã),
- –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π (–≥–æ–¥—ã).

–ß–µ–º –¥–ª–∏–Ω–Ω–µ–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç:
- —Ç–µ–º –ø—Ä–æ—â–µ –ø–µ—Ä–µ–∂–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ—Å–∞–¥–∫–∏,
- —Ç–µ–º –±–æ–ª–µ–µ –æ–ø—Ä–∞–≤–¥–∞–Ω–æ –¥–µ—Ä–∂–∞—Ç—å –∞–∫—Ü–∏–∏ –∏ ETF.

### 4.4. –ë–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞

- –ù–µ –≤–∫–ª–∞–¥—ã–≤–∞—Ç—å –≤—Å–µ –¥–µ–Ω—å–≥–∏ –≤ –æ–¥–Ω—É –∏–¥–µ—é.
- –ù–µ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ –¥–µ–Ω—å–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–∫–æ—Ä–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è.
- –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞—ë–º–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ (–∫—Ä–µ–¥–∏—Ç—ã) –¥–ª—è —Ç—Ä–µ–π–¥–∏–Ω–≥–∞.
- –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä –ø–æ—Ç–µ—Ä—å –ø–æ —Å–¥–µ–ª–∫–µ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø—ã —Å—Ç–æ–ø-–ª–æ—Å—Å).
        """,
        "questions": [
            {
                "q": "–ö–∞–∫–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–µ—Ä–Ω–æ?",
                "options": [
                    "–ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –≤—ã—Å–æ–∫–∏–π –¥–æ—Ö–æ–¥ –±–µ–∑ –∫–∞–∫–æ–≥–æ-–ª–∏–±–æ —Ä–∏—Å–∫–∞",
                    "–ß–µ–º –≤—ã—à–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å, —Ç–µ–º, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, –≤—ã—à–µ —Ä–∏—Å–∫",
                    "–†–∏—Å–∫ –∏ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –Ω–∏–∫–∞–∫ –Ω–µ —Å–≤—è–∑–∞–Ω—ã",
                    "–û–±–ª–∏–≥–∞—Ü–∏–∏ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–Ω–æ—Å—è—Ç –±–æ–ª—å—à–µ –¥–æ—Ö–æ–¥–∞, —á–µ–º –∞–∫—Ü–∏–∏",
                ],
                "correct": 1,
            },
            {
                "q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è?",
                "options": [
                    "–ü–æ–∫—É–ø–∫–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–π —Å–∞–º–æ–π –ø–æ–ø—É–ª—è—Ä–Ω–æ–π –∞–∫—Ü–∏–∏",
                    "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–ª–æ–∂–µ–Ω–∏–π –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –∞–∫—Ç–∏–≤–∞–º–∏",
                    "–ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Å–º–µ–Ω–∞ –±—Ä–æ–∫–µ—Ä–æ–≤",
                    "–ó–∞–ø—Ä–µ—Ç –Ω–∞ —Å–¥–µ–ª–∫–∏",
                ],
                "correct": 1,
            },
            {
                "q": "–ö–∞–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞ –Ω–∞–∏–±–æ–ª–µ–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ?",
                "options": [
                    "–í–∫–ª–∞–¥—ã–≤–∞—Ç—å –≤—Å–µ –¥–µ–Ω—å–≥–∏ –≤ –æ–¥–Ω—É —Å–¥–µ–ª–∫—É, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å",
                    "–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –∫—Ä–µ–¥–∏—Ç–Ω—ã–µ –¥–µ–Ω—å–≥–∏",
                    "–ù–µ —Ä–∏—Å–∫–æ–≤–∞—Ç—å –≤ –æ–¥–Ω–æ–π —Å–¥–µ–ª–∫–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —á–∞—Å—Ç—å—é –∫–∞–ø–∏—Ç–∞–ª–∞",
                    "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç—å –∏–∑ —É–±—ã—Ç–æ—á–Ω—ã—Ö —Å–¥–µ–ª–æ–∫",
                ],
                "correct": 2,
            },
        ],
    },
    {
        "id": "ch5",
        "title": "–ì–ª–∞–≤–∞ 5. –û—Å–Ω–æ–≤—ã —Ç—Ä–µ–π–¥–∏–Ω–≥–∞ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞",
        "text": """
–¢–µ–ø–µ—Ä—å ‚Äî —Å–∞–º–æ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ: **—á—Ç–æ –¥–µ–ª–∞–µ—Ç —Ç—Ä–µ–π–¥–µ—Ä** –∏ —á—Ç–æ –≤–∏–¥–Ω–æ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ.

### 5.1. –ò–Ω–≤–µ—Å—Ç–æ—Ä –∏ —Ç—Ä–µ–π–¥–µ—Ä

**–ò–Ω–≤–µ—Å—Ç–æ—Ä:**
- –¥–µ—Ä–∂–∏—Ç –∞–∫—Ç–∏–≤—ã –¥–æ–ª–≥–∏–π —Å—Ä–æ–∫ (–º–µ—Å—è—Ü—ã, –≥–æ–¥—ã),
- —Ä–µ–∂–µ —Å–æ–≤–µ—Ä—à–∞–µ—Ç —Å–¥–µ–ª–∫–∏,
- –±–æ–ª—å—à–µ –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã:
  - –±–∏–∑–Ω–µ—Å –∫–æ–º–ø–∞–Ω–∏–∏,
  - –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å,
  - —Å–æ—Å—Ç–æ—è–Ω–∏–µ —ç–∫–æ–Ω–æ–º–∏–∫–∏.

**–¢—Ä–µ–π–¥–µ—Ä:**
- –¥–µ–π—Å—Ç–≤—É–µ—Ç –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–æ–º–µ–∂—É—Ç–∫–∞—Ö (–æ—Ç –º–∏–Ω—É—Ç –¥–æ –Ω–µ–¥–µ–ª—å),
- –¥–µ–ª–∞–µ—Ç –º–Ω–æ–≥–æ —Å–¥–µ–ª–æ–∫,
- –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–≥—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑**,
- –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —ç–º–æ—Ü–∏–∏ –∏ —Ä–∏—Å–∫.

### 5.2. –¢–∞–π–º—Ñ—Ä–µ–π–º

**–¢–∞–π–º—Ñ—Ä–µ–π–º** ‚Äî –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–¥–Ω–æ–≥–æ ¬´—à–∞–≥a¬ª –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ:
- –¥–Ω–µ–≤–Ω–æ–π ‚Äî –æ–¥–Ω–∞ —Å–≤–µ—á–∞ = –æ–¥–∏–Ω –¥–µ–Ω—å,
- —á–∞—Å–æ–≤–æ–π ‚Äî –æ–¥–Ω–∞ —Å–≤–µ—á–∞ = –æ–¥–∏–Ω —á–∞—Å,
- 15-–º–∏–Ω—É—Ç–Ω—ã–π ‚Äî –æ–¥–Ω–∞ —Å–≤–µ—á–∞ = 15 –º–∏–Ω—É—Ç.

–í —Ç—Ä–µ–Ω–∞–∂—ë—Ä–µ:
- –¥–Ω–µ–≤–Ω–æ–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –ø–æ–º–æ–≥–∞–µ—Ç —É–≤–∏–¥–µ—Ç—å –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É,
- —á–∞—Å–æ–≤–æ–π –∏ 15-–º–∏–Ω—É—Ç–Ω—ã–π –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è.

### 5.3. –°–≤–µ—á–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫

–ö–∞–∂–¥–∞—è —Å–≤–µ—á–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç:
- **Open** ‚Äî —Ü–µ–Ω–∞ –≤ –Ω–∞—á–∞–ª–µ –ø–µ—Ä–∏–æ–¥–∞,
- **High** ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥,
- **Low** ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞,
- **Close** ‚Äî —Ü–µ–Ω–∞ –≤ –∫–æ–Ω—Ü–µ –ø–µ—Ä–∏–æ–¥–∞.

–¶–≤–µ—Ç:
- –∑–µ–ª—ë–Ω–∞—è —Å–≤–µ—á–∞ ‚Äî —Ü–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –≤—ã—à–µ —Ü–µ–Ω—ã –æ—Ç–∫—Ä—ã—Ç–∏—è (—Ä–æ—Å—Ç),
- –∫—Ä–∞—Å–Ω–∞—è —Å–≤–µ—á–∞ ‚Äî —Ü–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –Ω–∏–∂–µ —Ü–µ–Ω—ã –æ—Ç–∫—Ä—ã—Ç–∏—è (–ø–∞–¥–µ–Ω–∏–µ).

### 5.4. –¢—Ä–µ–Ω–¥—ã

**–¢—Ä–µ–Ω–¥** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã:
- –≤–æ—Å—Ö–æ–¥—è—â–∏–π (—Ü–µ–Ω–∞ –≤ —Å—Ä–µ–¥–Ω–µ–º —Ä–∞—Å—Ç—ë—Ç, –º–∞–∫—Å–∏–º—É–º—ã –∏ –º–∏–Ω–∏–º—É–º—ã –ø–æ–¥–Ω–∏–º–∞—é—Ç—Å—è),
- –Ω–∏—Å—Ö–æ–¥—è—â–∏–π (–º–∞–∫—Å–∏–º—É–º—ã –∏ –º–∏–Ω–∏–º—É–º—ã —Å–Ω–∏–∂–∞—é—Ç—Å—è),
- –±–æ–∫–æ–≤–æ–π (—Ñ–ª—ç—Ç) ‚Äî —Ü–µ–Ω–∞ —Ö–æ–¥–∏—Ç –≤ –∫–æ—Ä–∏–¥–æ—Ä–µ.

–¢—Ä–µ–π–¥–µ—Ä—ã —á–∞—Å—Ç–æ —Å—Ç–∞—Ä–∞—é—Ç—Å—è:
- –ø–æ–∫—É–ø–∞—Ç—å –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –≤–æ—Å—Ö–æ–¥—è—â–µ–≥–æ —Ç—Ä–µ–Ω–¥–∞,
- –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Å–¥–µ–ª–∫–∏ –ø—Ä–æ—Ç–∏–≤ —Å–∏–ª—å–Ω–æ–≥–æ —Ç—Ä–µ–Ω–¥–∞ –±–µ–∑ –≤–µ—Å–∫–∏—Ö –ø—Ä–∏—á–∏–Ω.

### 5.5. –£—Ä–æ–≤–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è

- **–£—Ä–æ–≤–µ–Ω—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏** ‚Äî –æ–±–ª–∞—Å—Ç—å, –æ—Ç–∫—É–¥–∞ —Ü–µ–Ω–∞ —Ä–∞–Ω–µ–µ —á–∞—Å—Ç–æ –æ—Ç—Å–∫–∞–∫–∏–≤–∞–ª–∞ –≤–≤–µ—Ä—Ö.
- **–£—Ä–æ–≤–µ–Ω—å —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è** ‚Äî –æ–±–ª–∞—Å—Ç—å, –æ—Ç –∫–æ—Ç–æ—Ä–æ–π —Ü–µ–Ω–∞ —Ä–∞–Ω—å—à–µ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–ª–∞—Å—å –≤–Ω–∏–∑.

–≠—Ç–æ –Ω–µ —Ç–æ—á–Ω—ã–µ –ª–∏–Ω–∏–∏, –∞ –∑–æ–Ω—ã,
–≥–¥–µ –≤ –ø—Ä–æ—à–ª–æ–º –±—ã–ª–æ –º–Ω–æ–≥–æ –∂–µ–ª–∞—é—â–∏—Ö –∫—É–ø–∏—Ç—å –∏–ª–∏ –ø—Ä–æ–¥–∞—Ç—å.

### 5.6. –ü–ª–∞–Ω —Å–¥–µ–ª–∫–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å —Ä–∏—Å–∫–∞

–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä:
1. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç **—Ç–æ—á–∫—É –≤—Ö–æ–¥–∞** (–≥–¥–µ –æ–Ω –±—É–¥–µ—Ç –ø–æ–∫—É–ø–∞—Ç—å/–ø—Ä–æ–¥–∞–≤–∞—Ç—å).
2. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç **—Å—Ç–æ–ø-–ª–æ—Å—Å** ‚Äî —É—Ä–æ–≤–µ–Ω—å, –≥–¥–µ –æ–Ω –≥–æ—Ç–æ–≤ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–±–æ–ª—å—à–æ–π —É–±—ã—Ç–æ–∫.
3. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç **—Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç** ‚Äî —É—Ä–æ–≤–µ–Ω—å, –≥–¥–µ –æ–Ω –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –ø—Ä–∏–±—ã–ª—å.
4. –ù–µ —Ä–∏—Å–∫—É–µ—Ç –≤ –æ–¥–Ω–æ–π —Å–¥–µ–ª–∫–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —á–∞—Å—Ç—å—é —Å—á—ë—Ç–∞
   (—á–∞—Å—Ç–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç 1‚Äì2% –æ—Ç –∫–∞–ø–∏—Ç–∞–ª–∞ –Ω–∞ –æ–¥–Ω—É —Å–¥–µ–ª–∫—É).

–ë–µ–∑ –ø–ª–∞–Ω–∞ —Ç—Ä–µ–π–¥–∏–Ω–≥ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –∏–≥—Ä—É ‚Äî –∞ –Ω–µ –≤ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–æ–º.
        """,
        "questions": [
            {
                "q": "–ß–µ–º —Ç—Ä–µ–π–¥–∏–Ω–≥ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è?",
                "options": [
                    "–¢—Ä–µ–π–¥–∏–Ω–≥ ‚Äî —ç—Ç–æ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –≥–æ–¥—ã",
                    "–¢—Ä–µ–π–¥–∏–Ω–≥ ‚Äî —ç—Ç–æ —á–∞—Å—Ç—ã–µ —Å–¥–µ–ª–∫–∏ –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–æ–º–µ–∂—É—Ç–∫–∞—Ö –≤—Ä–µ–º–µ–Ω–∏",
                    "–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–Ω–æ—Å–∏—Ç —É–±—ã—Ç–æ–∫",
                    "–û—Ç–ª–∏—á–∏–π –Ω–µ—Ç",
                ],
                "correct": 1,
            },
            {
                "q": "–ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–¥–Ω–∞ —Å–≤–µ—á–∞ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ?",
                "options": [
                    "–¢–æ–ª—å–∫–æ —Ü–µ–Ω—É –∑–∞–∫—Ä—ã—Ç–∏—è",
                    "–ú–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏",
                    "–î–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω –∑–∞ –ø–µ—Ä–∏–æ–¥: –æ—Ç–∫—Ä—ã—Ç–∏–µ, –º–∞–∫—Å–∏–º—É–º, –º–∏–Ω–∏–º—É–º, –∑–∞–∫—Ä—ã—Ç–∏–µ",
                    "–¢–æ–ª—å–∫–æ –æ–±—ä—ë–º —Å–¥–µ–ª–æ–∫",
                ],
                "correct": 2,
            },
            {
                "q": "–ó–∞—á–µ–º –Ω—É–∂–µ–Ω —Å—Ç–æ–ø-–ª–æ—Å—Å?",
                "options": [
                    "–ß—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–±—ã–ª—å",
                    "–ß—Ç–æ–±—ã –∑–∞—Ä–∞–Ω–µ–µ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–π —É–±—ã—Ç–æ–∫ –ø–æ —Å–¥–µ–ª–∫–µ",
                    "–ß—Ç–æ–±—ã –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –Ω–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏",
                    "–ß—Ç–æ–±—ã —É–≤–µ–ª–∏—á–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é",
                ],
                "correct": 1,
            },
        ],
    },
]


# ---------- –†–ê–ë–û–¢–ê –° –§–ê–ô–õ–ê–ú–ò ----------

def init_files() -> None:
    """–°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–¥–µ–ª–æ–∫ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞, –µ—Å–ª–∏ –∏—Ö –µ—â—ë –Ω–µ—Ç."""
    if not os.path.exists(USERS_FILE):
        df = pd.DataFrame(columns=["username", "password", "balance", "role"])
        df.to_csv(USERS_FILE, index=False)

    if not os.path.exists(TRADES_FILE):
        df = pd.DataFrame(columns=["username", "time", "ticker", "side", "qty", "price"])
        df.to_csv(TRADES_FILE, index=False)

    if not os.path.exists(PROGRESS_FILE):
        df = pd.DataFrame(columns=["username", "chapter_id", "correct", "total", "timestamp"])
        df.to_csv(PROGRESS_FILE, index=False)


def load_users() -> pd.DataFrame:
    df = pd.read_csv(USERS_FILE)
    # –Ω–∞ —Å–ª—É—á–∞–π —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –±–µ–∑ –∫–æ–ª–æ–Ω–∫–∏ role
    if "role" not in df.columns:
        df["role"] = "student"
    return df


def save_users(df: pd.DataFrame) -> None:
    df.to_csv(USERS_FILE, index=False)


def load_trades() -> pd.DataFrame:
    return pd.read_csv(TRADES_FILE)


def save_trades(df: pd.DataFrame) -> None:
    df.to_csv(TRADES_FILE, index=False)


def load_progress() -> pd.DataFrame:
    return pd.read_csv(PROGRESS_FILE)


def save_progress(df: pd.DataFrame) -> None:
    df.to_csv(PROGRESS_FILE, index=False)


# ---------- –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò –ò –ë–ê–õ–ê–ù–° ----------

def register_user(username: str, password: str, role: str = "student") -> tuple[bool, str]:
    users = load_users()
    if username in users["username"].values:
        return False, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

    new_user = pd.DataFrame(
        [[username, password, START_BALANCE, role]],
        columns=["username", "password", "balance", "role"],
    )
    users = pd.concat([users, new_user], ignore_index=True)
    save_users(users)
    return True, "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ"


def login_user(username: str, password: str) -> tuple[bool, str]:
    users = load_users()
    user = users[users["username"] == username]
    if user.empty:
        return False, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"
    if user.iloc[0]["password"] != password:
        return False, "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å"
    return True, "–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥"


def get_balance(username: str) -> float:
    users = load_users()
    return float(users[users["username"] == username]["balance"].iloc[0])


def update_balance(username: str, new_balance: float) -> None:
    users = load_users()
    users.loc[users["username"] == username, "balance"] = new_balance
    save_users(users)


def get_user_role(username: str) -> str:
    users = load_users()
    row = users[users["username"] == username]
    if row.empty:
        return "student"
    return str(row.iloc[0]["role"])


def delete_user(username: str) -> None:
    """–£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—Å–µ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ (—Å–¥–µ–ª–∫–∏, –ø—Ä–æ–≥—Ä–µ—Å—Å)."""
    users = load_users()
    users = users[users["username"] != username]
    save_users(users)

    trades = load_trades()
    trades = trades[trades["username"] != username]
    save_trades(trades)

    progress = load_progress()
    progress = progress[progress["username"] != username]
    save_progress(progress)


# ---------- –°–î–ï–õ–ö–ò –ò –ü–û–†–¢–§–ï–õ–¨ ----------

def add_trade(username: str, ticker: str, side: str, qty: int, price: float) -> None:
    trades = load_trades()
    new_trade = pd.DataFrame(
        [[username, datetime.now().isoformat(), ticker, side, qty, price]],
        columns=["username", "time", "ticker", "side", "qty", "price"],
    )
    trades = pd.concat([trades, new_trade], ignore_index=True)
    save_trades(trades)


def get_user_trades(username: str) -> pd.DataFrame:
    trades = load_trades()
    if trades.empty:
        return trades
    return trades[trades["username"] == username]


def calc_portfolio(username: str) -> pd.DataFrame:
    trades = get_user_trades(username)
    if trades.empty:
        return pd.DataFrame(columns=["ticker", "qty", "avg_price"])

    trades_group = (
        trades.assign(
            qty_signed=lambda df: df["qty"] * df["side"].map({"BUY": 1, "SELL": -1})
        ).groupby("ticker")
    )

    result_rows = []
    for ticker, grp in trades_group:
        total_qty = grp["qty_signed"].sum()
        if total_qty == 0:
            continue
        buys = grp[grp["side"] == "BUY"]
        if buys.empty:
            continue
        avg_price = (buys["qty"] * buys["price"]).sum() / buys["qty"].sum()
        result_rows.append({"ticker": ticker, "qty": total_qty, "avg_price": avg_price})

    if not result_rows:
        return pd.DataFrame(columns=["ticker", "qty", "avg_price"])

    return pd.DataFrame(result_rows)


# ---------- –ó–ê–ì–†–£–ó–ö–ê –ö–û–¢–ò–†–û–í–û–ö ----------

def _flatten_yf_columns(data: pd.DataFrame) -> pd.DataFrame:
    if isinstance(data.columns, pd.MultiIndex):
        data.columns = [c[0] for c in data.columns]
    return data


def get_last_price(ticker: str) -> float | None:
    try:
        data = yf.download(ticker, period="1d", interval="1m", progress=False)
        if data.empty:
            data = yf.download(ticker, period="5d", interval="1d", progress=False)
        if data.empty:
            return None

        data = _flatten_yf_columns(data)

        if "Close" not in data.columns and "Adj Close" in data.columns:
            data["Close"] = data["Adj Close"]

        return float(data["Close"].iloc[-1])
    except Exception:
        return None


def load_history(ticker: str, timeframe: str, days: int) -> pd.DataFrame:
    if days <= 0:
        days = 1
    period = f"{days}d"

    if timeframe == "–î–Ω–µ–≤–Ω–æ–π":
        interval = "1d"
    elif timeframe == "–ß–∞—Å–æ–≤–æ–π":
        interval = "60m"
    else:
        interval = "15m"

    try:
        data = yf.download(
            ticker,
            period=period,
            interval=interval,
            progress=False,
        )
    except Exception:
        return pd.DataFrame()

    if data.empty:
        return data

    data = _flatten_yf_columns(data)

    if "Close" not in data.columns and "Adj Close" in data.columns:
        data["Close"] = data["Adj Close"]

    for col in ["Open", "High", "Low"]:
        if col not in data.columns:
            data[col] = data["Close"]

    for col in ["Open", "High", "Low", "Close"]:
        data[col] = pd.to_numeric(data[col], errors="coerce")

    data[["Open", "High", "Low", "Close"]] = (
        data[["Open", "High", "Low", "Close"]].ffill().bfill()
    )

    if timeframe in ("–ß–∞—Å–æ–≤–æ–π", "15 –º–∏–Ω—É—Ç"):
        max_bars = 400
        if len(data) > max_bars:
            data = data.iloc[-max_bars:]

    return data


# ---------- –ü–†–û–ì–†–ï–°–° –ü–û –¢–ï–û–†–ò–ò ----------

def save_theory_result(username: str, chapter_id: str, correct: int, total: int) -> None:
    progress = load_progress()
    new_row = pd.DataFrame(
        [[username, chapter_id, correct, total, datetime.now().isoformat()]],
        columns=["username", "chapter_id", "correct", "total", "timestamp"],
    )
    progress = pd.concat([progress, new_row], ignore_index=True)
    save_progress(progress)


def render_theory_chapter(chapter_id: str, username: str):
    chapter = next(ch for ch in CHAPTERS if ch["id"] == chapter_id)

    st.subheader(chapter["title"])
    st.markdown(chapter["text"])

    st.markdown("### –¢–µ—Å—Ç –ø–æ –≥–ª–∞–≤–µ")

    answers = []
    for i, q in enumerate(chapter["questions"]):
        key = f"{chapter_id}_q_{i}"
        answer = st.radio(
            q["q"],
            q["options"],
            key=key,
            index=None,
        )
        answers.append(answer)

    if st.button(f"–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞–Ω–∏—è –ø–æ –≥–ª–∞–≤–µ", key=f"check_{chapter_id}"):
        correct_count = 0
        total = len(chapter["questions"])
        details = []

        for i, q in enumerate(chapter["questions"]):
            answer = answers[i]
            correct_option = q["options"][q["correct"]]
            if answer is None:
                details.append(f"–í–æ–ø—Ä–æ—Å {i + 1}: –æ—Ç–≤–µ—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω ‚ùì")
            elif answer == correct_option:
                correct_count += 1
                details.append(f"–í–æ–ø—Ä–æ—Å {i + 1}: –≤–µ—Ä–Ω–æ ‚úÖ")
            else:
                details.append(
                    f"–í–æ–ø—Ä–æ—Å {i + 1}: –Ω–µ–≤–µ—Ä–Ω–æ ‚ùå. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: **{correct_option}**"
                )

        save_theory_result(username, chapter_id, correct_count, total)

        st.markdown("---")
        for line in details:
            st.write(line)
        st.info(f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {correct_count} –∏–∑ {total} –≤–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.")


# ---------- –ü–ê–ù–ï–õ–¨ –£–ß–ò–¢–ï–õ–Ø ----------

def render_teacher_panel(current_username: str):
    st.subheader("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞–º–∏")

    users = load_users()
    students = users[users["role"] == "student"].copy()

    # –û–±—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    st.markdown("#### –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    show_df = users[["username", "role", "balance"]].copy()
    show_df = show_df.rename(
        columns={"username": "–õ–æ–≥–∏–Ω", "role": "–†–æ–ª—å", "balance": "–ë–∞–ª–∞–Ω—Å"}
    )
    st.dataframe(show_df, use_container_width=True)

    st.markdown("---")

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ–Ω–µ–≥ —É—á–µ–Ω–∏–∫—É
    st.markdown("#### –ù–∞–∑–Ω–∞—á–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏ —É—á–µ–Ω–∏–∫—É")

    if students.empty:
        st.write("–ü–æ–∫–∞ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤.")
    else:
        target_student = st.selectbox(
            "–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞",
            options=list(students["username"].values),
            key="teacher_add_money_student",
        )
        delta = st.number_input(
            "–°–∫–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏—Ç—å (–º–æ–∂–Ω–æ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è)",
            value=0.0,
            step=100.0,
        )
        if st.button("–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞"):
            old_balance = get_balance(target_student)
            new_balance = old_balance + delta
            update_balance(target_student, new_balance)
            st.success(
                f"–ë–∞–ª–∞–Ω—Å —É—á–µ–Ω–∏–∫–∞ {target_student} –∏–∑–º–µ–Ω—ë–Ω: –±—ã–ª–æ {old_balance:.2f}, —Å—Ç–∞–ª–æ {new_balance:.2f}."
            )

    st.markdown("---")

    # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞
    st.markdown("#### –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞")

    new_username = st.text_input("–õ–æ–≥–∏–Ω –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞", key="new_student_username")
    new_password = st.text_input(
        "–ü–∞—Ä–æ–ª—å –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞", type="password", key="new_student_password"
    )
    initial_balance = st.number_input(
        "–°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞",
        value=float(START_BALANCE),
        step=1000.0,
    )

    if st.button("–°–æ–∑–¥–∞—Ç—å —É—á–µ–Ω–∏–∫–∞"):
        if not new_username or not new_password:
            st.error("–£–∫–∞–∂–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.")
        else:
            ok, msg = register_user(new_username, new_password, role="student")
            if ok:
                update_balance(new_username, initial_balance)
                st.success(
                    f"–£—á–µ–Ω–∏–∫ {new_username} —Å–æ–∑–¥–∞–Ω. –°—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {initial_balance:.2f} —É.–µ."
                )
            else:
                st.error(msg)

    st.markdown("---")

    # –£–¥–∞–ª–µ–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞
    st.markdown("#### –£–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞")

    students_for_delete = students[students["username"] != current_username]
    if students_for_delete.empty:
        st.write("–ù–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
    else:
        del_student = st.selectbox(
            "–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è",
            options=list(students_for_delete["username"].values),
            key="del_student_username",
        )
        if st.button("–£–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞"):
            delete_user(del_student)
            st.warning(
                f"–£—á–µ–Ω–∏–∫ {del_student} –∏ –≤—Å–µ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ (—Å–¥–µ–ª–∫–∏, –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–æ—Ä–∏–∏) –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã."
            )

    st.markdown("---")

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ–æ—Ä–∏–∏
    st.subheader("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ–æ—Ä–∏–∏")

    progress = load_progress()
    if progress.empty:
        st.write("–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—é —Ç–µ–æ—Ä–∏–∏.")
    else:
        chapters_map = {ch["id"]: ch["title"] for ch in CHAPTERS}

        progress["chapter_title"] = progress["chapter_id"].map(chapters_map)
        progress["passed"] = progress["correct"] == progress["total"]

        # –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ –∫–∞–∂–¥–æ–π –ø–∞—Ä–µ (—É—á–µ–Ω–∏–∫, –≥–ª–∞–≤–∞)
        last_attempts = (
            progress.sort_values("timestamp")
            .groupby(["username", "chapter_id"], as_index=False)
            .tail(1)
        )

        # –°–≤–æ–¥–∫–∞ –ø–æ —É—á–µ–Ω–∏–∫–∞–º
        summary = (
            last_attempts.groupby("username")
            .agg(
                total_chapters=("chapter_id", "nunique"),
                passed_chapters=("passed", "sum"),
                avg_score=("correct", "mean"),
            )
            .reset_index()
        )
        summary = summary.rename(
            columns={
                "username": "–£—á–µ–Ω–∏–∫",
                "total_chapters": "–ì–ª–∞–≤ –∏–∑—É—á–µ–Ω–æ (—Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞)",
                "passed_chapters": "–ì–ª–∞–≤ —Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–µ—Ä–Ω—ã–º —Ç–µ—Å—Ç–æ–º",
                "avg_score": "–°—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –≤–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤",
            }
        )

        st.markdown("##### –°–≤–æ–¥–∫–∞ –ø–æ —É—á–µ–Ω–∏–∫–∞–º")
        st.dataframe(summary, use_container_width=True)

        st.markdown("##### –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ –≥–ª–∞–≤–∞–º")
        last_attempts_display = last_attempts[
            ["username", "chapter_title", "correct", "total", "timestamp", "passed"]
        ].rename(
            columns={
                "username": "–£—á–µ–Ω–∏–∫",
                "chapter_title": "–ì–ª–∞–≤–∞",
                "correct": "–í–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤",
                "total": "–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤",
                "timestamp": "–í—Ä–µ–º—è –ø–æ–ø—ã—Ç–∫–∏",
                "passed": "–¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é?",
            }
        )
        st.dataframe(last_attempts_display, use_container_width=True)

    st.markdown("---")

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç—Ä–µ–π–¥–∏–Ω–≥—É
    st.subheader("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–µ–π–¥–∏–Ω–≥–∞ —É—á–µ–Ω–∏–∫–æ–≤")

    if students.empty:
        st.write("–ü–æ–∫–∞ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–π–¥–∏–Ω–≥–∞.")
        return

    trades = load_trades()

    rows = []
    for _, row in students.iterrows():
        uname = row["username"]
        balance = float(row["balance"])

        user_trades = trades[trades["username"] == uname]
        num_trades = len(user_trades)

        portfolio = calc_portfolio(uname)
        portfolio_value = 0.0

        if not portfolio.empty:
            tickers = list(portfolio["ticker"].values)
            current_prices: dict[str, float | None] = {}
            for t in tickers:
                data = yf.download(t, period="5d", interval="1d", progress=False)
                if data.empty:
                    current_prices[t] = None
                    continue
                data = _flatten_yf_columns(data)
                if "Close" not in data.columns and "Adj Close" in data.columns:
                    data["Close"] = data["Adj Close"]
                current_prices[t] = float(data["Close"].iloc[-1])

            portfolio["–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞"] = portfolio["ticker"].map(current_prices)
            portfolio["–°—Ç–æ–∏–º–æ—Å—Ç—å"] = portfolio["qty"] * portfolio["–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞"]
            portfolio_value = portfolio["–°—Ç–æ–∏–º–æ—Å—Ç—å"].sum()

        total_equity = balance + portfolio_value

        rows.append(
            {
                "–£—á–µ–Ω–∏–∫": uname,
                "–ë–∞–ª–∞–Ω—Å (—Å–≤–æ–±–æ–¥–Ω—ã–µ –¥–µ–Ω—å–≥–∏)": round(balance, 2),
                "–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è": round(portfolio_value, 2),
                "–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (–±–∞–ª–∞–Ω—Å + –ø–æ—Ä—Ç—Ñ–µ–ª—å)": round(total_equity, 2),
                "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫": int(num_trades),
            }
        )

    stats_df = pd.DataFrame(rows)
    st.dataframe(stats_df, use_container_width=True)


# ---------- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø UI ----------

def main() -> None:
    st.set_page_config(
        page_title="–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ç—Ä–µ–Ω–∞–∂—ë—Ä",
        page_icon="üíπ",
        layout="wide",
    )

    st_autorefresh(interval=10_000, key="graph_auto_refresh")

    init_files()

    if "username" not in st.session_state:
        st.session_state.username = None

    st.title("üíπ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ç—Ä–µ–Ω–∞–∂—ë—Ä –ø–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–π–¥–∏–Ω–≥—É")

    # ---------- –ï–°–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ï–©–Å –ù–ï –í–û–®–Å–õ ----------
    if st.session_state.username is None:
        auth_tab, reg_tab = st.tabs(["–í—Ö–æ–¥", "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è"])

        with auth_tab:
            st.subheader("–í—Ö–æ–¥")
            login_username = st.text_input("–õ–æ–≥–∏–Ω", key="login_username")
            login_password = st.text_input(
                "–ü–∞—Ä–æ–ª—å", type="password", key="login_password"
            )
            if st.button("–í–æ–π—Ç–∏"):
                ok, msg = login_user(login_username, login_password)
                if ok:
                    st.session_state.username = login_username
                    st.success(msg)
                    st.rerun()
                else:
                    st.error(msg)

        with reg_tab:
            st.subheader("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è")
            reg_username = st.text_input("–ù–æ–≤—ã–π –ª–æ–≥–∏–Ω", key="reg_username")
            reg_password = st.text_input(
                "–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å", type="password", key="reg_password"
            )
            reg_role_label = st.selectbox(
                "–¢–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
                ["–£—á–µ–Ω–∏–∫", "–£—á–∏—Ç–µ–ª—å"],
                index=0,
            )
            role_value = "student" if reg_role_label == "–£—á–µ–Ω–∏–∫" else "teacher"

            if st.button("–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è"):
                if not reg_username or not reg_password:
                    st.error("–£–∫–∞–∂–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.")
                else:
                    ok, msg = register_user(reg_username, reg_password, role=role_value)
                    if ok:
                        st.success(msg)
                    else:
                        st.error(msg)

        st.info("–ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Ç—Ä–µ–Ω–∞–∂—ë—Ä, —Ç–µ–æ—Ä–∏—è –∏ (–¥–ª—è —É—á–∏—Ç–µ–ª—è) –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.")
        return

    # ---------- –ï–°–õ–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ê–í–¢–û–†–ò–ó–û–í–ê–ù ----------
    username = st.session_state.username
    role = get_user_role(username)

    top_cols = st.columns([3, 1])
    with top_cols[0]:
        st.success(f"–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ **{username}** ({'—É—á–∏—Ç–µ–ª—å' if role == 'teacher' else '—É—á–µ–Ω–∏–∫'})")
    with top_cols[1]:
        if st.button("–í—ã–π—Ç–∏", key="logout"):
            st.session_state.username = None
            st.rerun()

    balance = get_balance(username)
    st.metric("–ë–∞–ª–∞–Ω—Å", f"{balance:,.2f} —É.–µ.")

    st.markdown("---")

    # –ù–∞–±–æ—Ä –≤–∫–ª–∞–¥–æ–∫ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–æ–ª–∏
    if role == "teacher":
        teacher_tab, trade_tab, theory_tab = st.tabs(
            ["üë®‚Äçüè´ –ü–∞–Ω–µ–ª—å —É—á–∏—Ç–µ–ª—è", "üìà –¢—Ä–µ–Ω–∞–∂—ë—Ä", "üìö –¢–µ–æ—Ä–∏—è"]
        )
    else:
        trade_tab, theory_tab = st.tabs(["üìà –¢—Ä–µ–Ω–∞–∂—ë—Ä", "üìö –¢–µ–æ—Ä–∏—è"])
        teacher_tab = None

    # ---------- –ü–ê–ù–ï–õ–¨ –£–ß–ò–¢–ï–õ–Ø ----------
    if teacher_tab is not None:
        with teacher_tab:
            render_teacher_panel(username)

    # ---------- –í–ö–õ–ê–î–ö–ê –¢–†–ï–ù–ê–ñ–Å–†–ê ----------
    with trade_tab:
        col1, col2 = st.columns([2.2, 1])

        with col1:
            st.subheader("–ì—Ä–∞—Ñ–∏–∫ —Ü–µ–Ω—ã")

            ticker_for_chart = st.selectbox(
                "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç",
                options=list(TICKERS.keys()),
                format_func=lambda t: f"{t} ‚Äî {TICKERS[t]}",
                key="chart_ticker",
            )

            timeframe = st.selectbox(
                "–¢–∞–π–º—Ñ—Ä–µ–π–º",
                ["–î–Ω–µ–≤–Ω–æ–π", "–ß–∞—Å–æ–≤–æ–π", "15 –º–∏–Ω—É—Ç"],
                index=0,
            )

            if timeframe == "–î–Ω–µ–≤–Ω–æ–π":
                max_days = 365
                default_days = 60
            elif timeframe == "–ß–∞—Å–æ–≤–æ–π":
                max_days = 30
                default_days = 7
            else:
                max_days = 10
                default_days = 3

            days = st.slider(
                "–°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å",
                min_value=1,
                max_value=max_days,
                value=default_days,
            )

            chart_type = st.selectbox(
                "–¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞",
                ["–õ–∏–Ω–µ–π–Ω—ã–π", "–°–≤–µ—á–Ω–æ–π (candlestick)"],
                index=0,
            )

            data = load_history(ticker_for_chart, timeframe, days)

            if data.empty:
                st.error(
                    "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞. "
                    "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏–ª–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º."
                )
            else:
                if chart_type == "–õ–∏–Ω–µ–π–Ω—ã–π":
                    st.line_chart(data["Close"])
                else:
                    if data[["Open", "High", "Low", "Close"]].isna().all().all():
                        st.warning(
                            "–î–ª—è —ç—Ç–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –Ω–µ —É–¥–∞–ª–æ—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ OHLC. "
                            "–ü–æ–∫–∞–∑–∞–Ω –ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫."
                        )
                        st.line_chart(data["Close"])
                    else:
                        fig = go.Figure(
                            data=[
                                go.Candlestick(
                                    x=data.index,
                                    open=data["Open"],
                                    high=data["High"],
                                    low=data["Low"],
                                    close=data["Close"],
                                    showlegend=False,
                                )
                            ]
                        )
                        fig.update_layout(
                            xaxis_title="–í—Ä–µ–º—è",
                            yaxis_title="–¶–µ–Ω–∞",
                            margin=dict(l=10, r=10, t=30, b=30),
                            xaxis_rangeslider_visible=False,
                        )
                        st.plotly_chart(fig, use_container_width=True)

                last_price_chart = float(data["Close"].iloc[-1])
                st.info(
                    f"–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ {ticker_for_chart} "
                    f"({TICKERS[ticker_for_chart]}): **{last_price_chart:.2f}**"
                )

        with col2:
            st.subheader("–°–æ–≤–µ—Ä—à–∏—Ç—å —Å–¥–µ–ª–∫—É")

            ticker_for_trade = st.selectbox(
                "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–¥–µ–ª–∫–∏",
                options=list(TICKERS.keys()),
                format_func=lambda t: f"{t} ‚Äî {TICKERS[t]}",
                key="trade_ticker",
            )

            st.markdown("**–í–∞—à —Ç–µ–∫—É—â–∏–π –ø–æ—Ä—Ç—Ñ–µ–ª—å (–º–æ–∂–Ω–æ –ø—Ä–æ–¥–∞—Ç—å):**")
            mini_portfolio = calc_portfolio(username)
            if mini_portfolio.empty or (mini_portfolio["qty"] <= 0).all():
                st.caption("–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.")
            else:
                sellable = mini_portfolio[mini_portfolio["qty"] > 0].copy()
                sellable_display = sellable.rename(
                    columns={
                        "ticker": "–¢–∏–∫–µ—Ä",
                        "qty": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ",
                        "avg_price": "–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞",
                    }
                )
                st.dataframe(sellable_display, use_container_width=True, height=200)

            side = st.selectbox("–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏", ["BUY", "SELL"])
            qty = st.number_input("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", min_value=1, step=1)

            if st.button("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–¥–µ–ª–∫—É"):
                balance_now = get_balance(username)
                price = get_last_price(ticker_for_trade)

                if price is None:
                    st.error(
                        "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑."
                    )
                else:
                    total_cost = price * qty
                    portfolio = calc_portfolio(username)

                    if side == "BUY":
                        if total_cost > balance_now:
                            st.error("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á—ë—Ç–µ.")
                        else:
                            update_balance(username, balance_now - total_cost)
                            add_trade(username, ticker_for_trade, side, qty, price)
                            st.success(
                                f"–ö—É–ø–ª–µ–Ω–æ {qty} {ticker_for_trade} –ø–æ —Ü–µ–Ω–µ {price:.2f}. "
                                f"–°–ø–∏—Å–∞–Ω–æ {total_cost:.2f} —É.–µ."
                            )
                    else:
                        pos = portfolio[portfolio["ticker"] == ticker_for_trade]
                        current_qty = int(pos["qty"].iloc[0]) if not pos.empty else 0
                        if qty > current_qty:
                            st.error("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—É–º–∞–≥–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏.")
                        else:
                            update_balance(username, balance_now + total_cost)
                            add_trade(username, ticker_for_trade, side, qty, price)
                            st.success(
                                f"–ü—Ä–æ–¥–∞–Ω–æ {qty} {ticker_for_trade} –ø–æ —Ü–µ–Ω–µ {price:.2f}. "
                                f"–ó–∞—á–∏—Å–ª–µ–Ω–æ {total_cost:.2f} —É.–µ."
                            )

        st.markdown("---")

        st.subheader("–ú–æ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å")

        portfolio = calc_portfolio(username)
        if portfolio.empty:
            st.write("–ü–æ—Ä—Ç—Ñ–µ–ª—å –ø–æ–∫–∞ –ø—É—Å—Ç.")
        else:
            tickers_list = list(portfolio["ticker"].values)
            current_prices: dict[str, float | None] = {}

            for t in tickers_list:
                data = yf.download(t, period="5d", interval="1d", progress=False)
                if data.empty:
                    current_prices[t] = None
                    continue
                data = _flatten_yf_columns(data)
                if "Close" not in data.columns and "Adj Close" in data.columns:
                    data["Close"] = data["Adj Close"]
                current_prices[t] = float(data["Close"].iloc[-1])

            portfolio["–ù–∞–∑–≤–∞–Ω–∏–µ"] = portfolio["ticker"].map(lambda x: TICKERS.get(x, x))
            portfolio["–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞"] = portfolio["ticker"].map(current_prices)
            portfolio["–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–∏"] = portfolio["qty"] * portfolio["–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞"]
            portfolio["PnL"] = (
                (portfolio["–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞"] - portfolio["avg_price"]) * portfolio["qty"]
            )

            portfolio_display = portfolio[
                [
                    "ticker",
                    "–ù–∞–∑–≤–∞–Ω–∏–µ",
                    "qty",
                    "avg_price",
                    "–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞",
                    "–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–∏",
                    "PnL",
                ]
            ].rename(
                columns={
                    "ticker": "–¢–∏–∫–µ—Ä",
                    "qty": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ",
                    "avg_price": "–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞",
                }
            )

            st.dataframe(portfolio_display, use_container_width=True)

        st.subheader("–ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫")
        trades = get_user_trades(username)
        if trades.empty:
            st.write("–°–¥–µ–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.")
        else:
            trades_display = trades.sort_values("time", ascending=False)
            st.dataframe(trades_display, use_container_width=True)

    # ---------- –í–ö–õ–ê–î–ö–ê –¢–ï–û–†–ò–ò ----------
    with theory_tab:
        st.header("–£—á–µ–±–Ω–∏–∫ –ø–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏ –∏ —Ç—Ä–µ–π–¥–∏–Ω–≥—É")

        chapter_titles = [ch["title"] for ch in CHAPTERS]
        selected_title = st.selectbox(
            "–í—ã–±–µ—Ä–∏—Ç–µ –≥–ª–∞–≤—É —É—á–µ–±–Ω–∏–∫–∞",
            options=chapter_titles,
        )

        selected_id = next(ch["id"] for ch in CHAPTERS if ch["title"] == selected_title)

        render_theory_chapter(selected_id, username)


if __name__ == "__main__":
    main()
